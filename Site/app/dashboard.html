<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DashBoard</title>
    <link rel="stylesheet" href="dashboard.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <header class="navbar">
        <div class="logo">
            <img src="./Imgs/ICONE.png" alt="Cosmos Tech Logo" />
            <span>
                <span class="cosmos">COSMOS</span>
                <span class="tech">TECH</span>
            </span>

            <nav class="menu">
                <a href="software.html"> Nosso Lar</a>
                <a href="viagens.html">Viagens</a>
                <a class="active" href="dashboard.html">Dashboard</a>
            </nav>
        </div>
    </header>

    <section class="dashboard">
        <div class="dashboard-container">
            <div class="top-user">
                <div class="user-info">
                    <h2>Ol√°, <span id="b_usuario">Usu√°rio</span> üëã</h2>
                    <p>Bem-vindo ao seu painel de desempenho!</p>
                </div>

                <div class="kpis">
                    <div class="kpi-card">
                        <h4>Voc√™ se interessa mais por</h4>
                        <p id="quiz_mais_jogado">Ainda n√£o jogou nenhum quiz...</p>
                    </div>

                    <div class="kpi-card">
                        <h4>Sua maior pontua√ß√£o foi </h4>
                        <p id="maior_pontuacao">Sem pontua√ß√£o...</p>
                    </div>
                    <div class="kpi-card">
                        <h4>Quanto voc√™ jogou o quiz Sistema solar</h4>
                        <p id="qtdSolarMsg">Sem pontua√ß√£o...</p>
                    </div>
                    <div class="kpi-card">
                        <h4>Quanto voc√™ jogou o quiz de viagens espacias</h4>
                        <p id="qtdViagensMsg">Sem pontua√ß√£o...</p>
                    </div>
                </div>
            </div>

            <div class="grafico-box">
                <div class="graficos-lado">
                    <div class="grafico-item">
                        <h3>Desempenho(%) ‚Äî Sistema Solar </h3>
                        <div class="estiloGrafico">
                            <canvas id="graficoSistemaSolar"></canvas>
                        </div>
                    </div>

                    <div class="grafico-item">
                        <h3>Desempenho (%) ‚Äî Viagens Espaciais </h3>
                        <div class="estiloGrafico">
                            <canvas id="graficoViagensEspaciais"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</body>

</html>

<script>

    // fetch busca dados da API
    b_usuario.innerHTML = sessionStorage.NOME_USUARIO;

    // fun√ß√£o que vai coletar carregador todos os resultados das fun√ß√£o criarGr√°fico e a
    function carregarResultado() {
        var idUsuario = sessionStorage.ID_USUARIO;

        fetch(`/quiz/resultados/${idUsuario}`)
            .then((res) => res.json())
            .then((dados) => {
                console.log("Resultados recebidos: ", dados);
                criarGrafico(dados);
                kpis(dados);
            })
            .catch((err) => console.log("Erro ao carregar os resultados", err));
    }

    // fun√ß√£o que vai criar as kpis

    function kpis(dados) {

        // os dados come√ßa em nagativo pois se come√ßa com zero e ele fez 0 quiz vai falhar na valida√ß√£o do if 
        var quizMaisJogado = null;

        var maiorJogadoValor = -1;
        var quizMaisPontuacao = null;

        var maiorPontoValor = -1;

        var qtdSolar = 0;
        var qtdViagens = 0;

        for (var i = 0; i < dados.length; i++) {
            var nome = dados[i].nomeQuiz;
            var certos = Number(dados[i].totalCerto);
            var erros = Number(dados[i].totalErrado);
            var total = certos + erros;

        

            if (total > maiorJogadoValor) {
                maiorJogadoValor = total;
                quizMaisJogado = nome;
            }

            if (certos > maiorPontoValor) {
                maiorPontoValor = certos;
                quizMaiorPontuacao = nome;
            }
            if (nome.includes("Sistema solar")) {
                qtdSolar += (certos + erros)/4;
            }

            if (nome.includes("Viagens espaciais")) {
                qtdViagens += (certos + erros)/4;
            }
        }

        if (qtdSolar == 0) {
            qtdSolarMsg.innerHTML = "Nunca jogou"
        }
        else {
            qtdSolarMsg.innerHTML = `${qtdSolar} vezes`
        };

        if (qtdViagens == 0) {
            qtdViagensMsg.innerHTML = "Nunca jogou"
        }
        else {
            qtdViagensMsg.innerHTML = `${qtdViagens} vezes`
        };

        quiz_mais_jogado.innerHTML = quizMaisJogado;
        maior_pontuacao.innerHTML = `${maiorPontoValor} pontos ‚Äî ${quizMaiorPontuacao}`;
    }

    function criarGrafico(dados) {
        var nomes = [];
        var acertos = [];
        var erros = [];

        var nomeSolar = [];
        var acertosSolar = [];
        var errosSolar = [];

        var nomeViagens = [];
        var acertosViagens = [];
        var errosViagens = [];

        var somaAcertosSolar = 0;
        var somaErrosSolar = 0;

        var somaAcertosViagens = 0;
        var somaErrosViagens = 0;

        for (var i = 0; i < dados.length; i++) {
            nomes.push(dados[i].nomeQuiz);
            acertos.push(dados[i].totalCerto);
            erros.push(dados[i].totalErrado);

            if (dados[i].nomeQuiz.includes("Sistema solar")) {
                nomeSolar.push(dados[i].nomeQuiz);
                acertosSolar.push(dados[i].totalCerto);  
                errosSolar.push(dados[i].totalErrado);


                somaAcertosSolar += Number(dados[i].totalCerto);
                somaErrosSolar += Number(dados[i].totalErrado);

            }
            if (dados[i].nomeQuiz.includes("Viagens espaciais")) {
                nomeViagens.push(dados[i].nomeQuiz);
                acertosViagens.push(dados[i].totalCerto);
                errosViagens.push(dados[i].totalErrado);

                somaAcertosViagens += Number(dados[i].totalCerto);
                somaErrosViagens += Number(dados[i].totalErrado);
            }
        }

        var acertosSolarPorc = 0;
        var errosSolarPorc = 0;

        var acertosViagensPorc = 0;
        var errosViagensPorc = 0;

        var totalSolar = somaAcertosSolar + somaErrosSolar;
        var totalViagens = somaAcertosViagens + somaErrosViagens;


        if (totalSolar === 0) {
            acertosSolarPorc = 0;
            errosSolarPorc = 0;
        } else {
            acertosSolarPorc = (somaAcertosSolar / totalSolar) * 100;
            errosSolarPorc = (somaErrosSolar / totalSolar) * 100;
        }

        if (totalViagens === 0) {
            acertosViagensPorc = 0;
            errosViagensPorc = 0;
        } else {
            acertosViagensPorc = (somaAcertosViagens / totalViagens) * 100;
            errosViagensPorc = (somaErrosViagens / totalViagens) * 100;
        }





        const ctx1 = document.getElementById("graficoSistemaSolar").getContext("2d");
        new Chart(ctx1, {
            type: "pie",
            data: {
                labels: ["Acertos", "Erros"],
                datasets: [{
                    data: [acertosSolarPorc, errosSolarPorc],
                    backgroundColor: [
                        "rgba(79, 224, 255, 0.6)",
                        "rgba(255, 99, 132, 0.6)"
                    ]
                }]
            },
            options: { responsive: true }
        });

        const ctx2 = document.getElementById("graficoViagensEspaciais").getContext("2d");
        new Chart(ctx2, {
            type: "pie",
            data: {
                labels: ["Acertos", "Erros"],
                datasets: [{
                    data: [acertosViagensPorc, errosViagensPorc],
                    backgroundColor: [
                        "rgba(79, 224, 255, 0.6)",
                        "rgba(255, 99, 132, 0.6)"
                    ]
                }]
            },
            options: { responsive: true }
        });

    }

    carregarResultado();
</script>